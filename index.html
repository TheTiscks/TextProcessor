<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>üîí Client-only Cryptor</title>
</head>
<body>
  <h2>Client-only Cryptor</h2>

  <textarea id="text" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
  <input id="key" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)"/>
  <div>
    <button id="encryptBtn">–®–∏—Ñ—Ä–æ–≤–∞—Ç—å –∏ —É–ø–∞–∫–æ–≤–∞—Ç—å</button>
    <button id="decryptBtn">–î–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –ø–∞–∫–µ—Ç</button>
  </div>

  <div id="result" style="margin-top:1rem;color:blue;"></div>
  <div id="linkResult" style="margin-top:1rem;display:none;"></div>

  <script type="module">
    import { encryptText, decryptBlob, packBlob, unpackBlob } from "./crypto.js";

    function showMessage(msg, color="blue") {
      const r = document.getElementById("result");
      r.style.color = color;
      r.textContent = msg;
    }

    document.getElementById("encryptBtn").addEventListener("click", async () => {
      const text = document.getElementById("text").value;
      let password = document.getElementById("key").value;
      if (!text) return showMessage("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!", "red");
      if (!password) {
        password = Array.from(crypto.getRandomValues(new Uint8Array(16)))
          .map(b => ("00" + b.toString(16)).slice(-2)).join("");
        alert("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø–∞—Ä–æ–ª—å: " + password);
      }
      const enc = await encryptText(text, password);
      const packed = packBlob(enc);
      showMessage("‚úÖ –£–ø–∞–∫–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ", "green");

      const out = document.getElementById("linkResult");
      out.style.display = "block";
      out.innerHTML = `
        <textarea id="packedArea" rows="6" style="width:100%;">${packed}</textarea>
        <div style="margin-top:.5rem;">
          <button id="copyBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button id="downloadBtn">–°–∫–∞—á–∞—Ç—å</button>
        </div>
      `;
      document.getElementById("copyBtn").addEventListener("click", () => {
        navigator.clipboard.writeText(document.getElementById("packedArea").value);
      });
      document.getElementById("downloadBtn").addEventListener("click", () => {
        const blob = new Blob([document.getElementById("packedArea").value], {type:"text/plain"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "secret.pkg";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
    });

    document.getElementById("decryptBtn").addEventListener("click", async () => {
      const packed = document.getElementById("text").value.trim();
      const password = document.getElementById("key").value;
      if (!packed || !password) return showMessage("–í–≤–µ–¥–∏—Ç–µ –ø–∞–∫–µ—Ç –∏ –ø–∞—Ä–æ–ª—å!", "red");
      try {
        const blob = unpackBlob(packed);
        const plain = await decryptBlob(blob, password);
        showMessage("üîì –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ: " + plain, "green");
      } catch (e) {
        showMessage("–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏: " + e.message, "red");
      }
    });
  </script>
</body>
</html>
