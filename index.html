<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>üîí Client-only Cryptor</title>
</head>
<body>
  <h2>Client-only Cryptor</h2>

  <textarea id="text" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
  <input id="key" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)"/>
  <div>
    <button id="encryptBtn">–®–∏—Ñ—Ä–æ–≤–∞—Ç—å –∏ —É–ø–∞–∫–æ–≤–∞—Ç—å</button>
    <button id="decryptBtn">–î–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –ø–∞–∫–µ—Ç</button>
  </div>

  <div id="result" style="margin-top:1rem;color:blue;"></div>
  <div id="linkResult" style="margin-top:1rem;display:none;"></div>

  <script type="module">
  import {
    generateKeyString,
    base64UrlToBytes,
    encryptWithRawKey,
    decryptWithRawKey,
    packBlobJSON,
    unpackBlobJSON
  } from "./crypto.js";

  function showMessage(msg, color = "blue") {
    const r = document.getElementById("result");
    r.style.color = color;
    r.textContent = msg;
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ (base64url) –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–æ–ª–µ
  document.getElementById("encryptBtn").addEventListener("click", async () => {
    const text = document.getElementById("text").value;
    let keyStr = document.getElementById("key").value.trim();

    if (!text) {
      return showMessage("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!", "red");
    }

    // –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ –≤–≤–µ–¥—ë–Ω ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π 256-–±–∏—Ç–Ω—ã–π –∫–ª—é—á –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    if (!keyStr) {
      keyStr = generateKeyString();
      document.getElementById("key").value = keyStr;
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å/–ø–µ—Ä–µ–¥–∞—Ç—å –∫–ª—é—á –ø–æ –¥—Ä—É–≥–æ–º—É –∫–∞–Ω–∞–ª—É!
      alert("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–ª—é—á (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ):\n\n" + keyStr);
      showMessage("–ö–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω–æ.", "green");
    }

    try {
      // raw key –∏–∑ base64url
      const raw = base64UrlToBytes(keyStr);
      const blob = await encryptWithRawKey(text, raw);
      const packed = packBlobJSON(blob); // —Å—Ç—Ä–æ–∫–∞, –≥–æ—Ç–æ–≤–∞—è –∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—é/—Å–∫–∞—á–∏–≤–∞–Ω–∏—é

      showMessage("‚úÖ –£–ø–∞–∫–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ", "green");

      const out = document.getElementById("linkResult");
      out.style.display = "block";
      out.innerHTML = `
        <label>–ü–∞–∫–µ—Ç (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∞–¥—Ä–µ—Å–∞—Ç—É):</label>
        <textarea id="packedArea" rows="6" style="width:100%;">${packed}</textarea>
        <div style="margin-top:.5rem;">
          <button id="copyBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞–∫–µ—Ç</button>
          <button id="downloadBtn">–°–∫–∞—á–∞—Ç—å –ø–∞–∫–µ—Ç</button>
        </div>
      `;

      document.getElementById("copyBtn").addEventListener("click", async () => {
        await navigator.clipboard.writeText(document.getElementById("packedArea").value);
        showMessage("–ü–∞–∫–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞", "green");
      });

      document.getElementById("downloadBtn").addEventListener("click", () => {
        const content = document.getElementById("packedArea").value;
        const blobFile = new Blob([content], { type: "text/plain" });
        const url = URL.createObjectURL(blobFile);
        const a = document.createElement("a");
        a.href = url;
        a.download = "secret.pkg";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
    } catch (e) {
      console.error(e);
      showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–∏: " + (e.message || e), "red");
    }
  });

  // –î–µ—à–∏—Ñ—Ä–æ–≤–∫–∞: –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —É–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–π –ø–∞–∫–µ—Ç + –∫–ª—é—á –≤ –ø–æ–ª–µ 'key'
  document.getElementById("decryptBtn").addEventListener("click", async () => {
    const packed = document.getElementById("text").value.trim();
    const keyStr = document.getElementById("key").value.trim();
    if (!packed || !keyStr) return showMessage("–í—Å—Ç–∞–≤—å—Ç–µ –ø–∞–∫–µ—Ç –∏ –∫–ª—é—á!", "red");

    try {
      const blob = unpackBlobJSON(packed);
      const raw = base64UrlToBytes(keyStr);
      const plain = await decryptWithRawKey(blob, raw);
      showMessage("üîì –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ: " + plain, "green");
      // –æ–ø—Ü–∏—è: –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–∞–∫–µ—Ç–∞ (burn after open ‚Äî –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –æ–ø—Ü–∏—è)
      // document.getElementById("text").value = "";
    } catch (e) {
      console.error(e);
      showMessage("–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏: " + (e.message || e), "red");
    }
  });
</script>
</body>
</html>
